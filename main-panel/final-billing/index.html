<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Application | Final Billing POS</title>
    <link rel="icon" href="../../images/favicon.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../../styles/common.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        .pos-grid-item {
            transition: all 0.2s;
        }

        .pos-grid-item:active {
            transform: scale(0.95);
        }

        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>

<body class="min-h-screen flex flex-col bg-gray-50 font-sans">

    <!--Nav-->
    <div class="nav bg-basic w-full py-4 flex justify-between items-center px-8 shadow-md">
        <!-- Left: Navigation -->
        <div class="flex items-center gap-4">
            <button onclick="history.back()"
                class="w-10 h-10 bg-white text-basic rounded-full flex items-center justify-center hover:scale-95 transition-transform shadow-sm">
                <i class="bi bi-chevron-left text-lg"></i>
            </button>
            <button onclick="window.location.href = '../';"
                class="px-4 py-2 bg-white text-basic rounded-lg flex items-center gap-2 hover:scale-95 transition-transform shadow-sm font-semibold text-sm">
                <i class="bi bi-building"></i>
                <span class="hidden sm:inline">Go to Main Panel</span>
            </button>
        </div>

        <!-- Center: Logo -->
        <div class="flex-1 flex justify-center">
            <img src="../../images/logo.png" alt="Logo" class="h-12 w-auto drop-shadow-md">
        </div>

        <!-- Right: User Info -->
        <div class="flex items-center gap-4">
            <!-- Held Bills (Moved from old header) -->
            <button onclick="showHeldBills()"
                class="relative w-10 h-10 bg-white/10 rounded-full text-white hover:bg-white/20 transition-colors flex items-center justify-center"
                title="Held Bills">
                <i class="bi bi-pause-circle text-lg"></i>
                <span id="heldCountBadge"
                    class="hidden absolute -top-1 -right-1 w-4 h-4 bg-red-500 text-white text-[10px] font-bold rounded-full flex justify-center items-center shadow-sm border border-white">0</span>
            </button>

            <div class="text-right text-white hidden sm:block">
                <h2 class="text-lg font-bold leading-tight">Good Evening!</h2>
                <p class="text-xs text-blue-200">Welcome Admin</p>
            </div>
            <button onclick="window.location.href = '../../';"
                class="w-10 h-10 bg-white text-basic rounded-full flex items-center justify-center hover:scale-95 transition-transform shadow-sm">
                <i class="bi bi-box-arrow-right text-lg"></i>
            </button>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="flex-grow flex flex-col md:flex-row">

        <!-- LEFT PANEL: Pending Bills Grid -->
        <div class="flex-grow flex flex-col bg-gray-100/50">
            <!-- Sub-header / Filters -->
            <div
                class="bg-white border-b border-gray-200 px-6 py-4 flex flex-col sm:flex-row justify-between items-center gap-4 shadow-sm">
                <h1 class="text-xl font-bold text-gray-800 uppercase tracking-wider flex items-center gap-2">
                    Final Billing <span
                        class="text-sm bg-blue-100 text-blue-700 px-2 py-0.5 rounded font-bold">POS</span>
                </h1>

                <div class="relative w-full sm:w-80">
                    <i class="bi bi-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="searchInput" onkeyup="handleSearch()" placeholder="Search Bills..."
                        class="w-full pl-12 pr-4 py-2 rounded-lg border border-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none bg-gray-50 focus:bg-white transition-all">
                </div>
            </div>

            <div
                class="px-6 py-2 flex items-center gap-3 text-xs text-gray-500 bg-gray-50 border-b border-gray-200 overflow-x-auto">
                <span class="font-bold uppercase tracking-wide">Queue:</span>
                <span
                    class="bg-white px-3 py-1 rounded-full font-semibold shadow-sm border border-gray-200 flex items-center gap-1 whitespace-nowrap">
                    <i class="bi bi-clock-history text-blue-600"></i> Pending Bills
                </span>
                <span
                    class="bg-white px-3 py-1 rounded-full font-semibold shadow-sm border border-gray-200 opacity-50 whitespace-nowrap">
                    <i class="bi bi-check-circle"></i> Completed
                </span>
            </div>

            <!-- Content -->
            <div class="flex-grow p-6" id="mainContent">
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-5" id="gridContainer">
                    <!-- Grid Items -->
                </div>
            </div>
        </div>

        <!-- RIGHT PANEL: Cart / Transaction -->
        <div class="w-full md:w-[420px] bg-white flex flex-col shadow-2xl z-20 shrink-0 border-l border-gray-200">
            <!-- Customer Info -->
            <!-- Customer Search / Info Header -->
            <div
                class="h-20 bg-gradient-to-br from-gray-50 to-white border-b border-gray-200 flex items-center px-6 justify-between relative z-40">

                <!-- Search Mode (Default) -->
                <div id="customerSearchContainer" class="w-full mr-4 relative">
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="bi bi-search text-gray-400"></i>
                        </div>
                        <input type="text" id="customerSearchInput"
                            class="block w-full pl-10 pr-10 py-2.5 border border-gray-200 rounded-xl leading-5 bg-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-400 sm:text-sm transition-all shadow-sm"
                            placeholder="Search Customer (Name / Phone)..." onkeyup="searchCustomer(this.value)"
                            onfocus="searchCustomer(this.value)" autocomplete="off">
                        <div class="absolute inset-y-0 right-0 pr-3 flex items-center cursor-pointer text-gray-400 hover:text-gray-600"
                            onclick="clearCustomerSearch()">
                            <i class="bi bi-x-circle-fill" id="searchClearIcon" style="display: none;"></i>
                        </div>
                    </div>

                    <!-- Dropdown Results -->
                    <div id="customerSearchResults"
                        class="hidden absolute mt-2 w-full bg-white shadow-xl rounded-xl py-1 text-base ring-1 ring-black ring-opacity-5 overflow-auto max-h-80 focus:outline-none sm:text-sm z-50">
                        <!-- Results injected here -->
                    </div>
                </div>

                <!-- Selected Customer Display (Hidden by default) -->
                <div id="selectedCustomerDisplay" class="hidden flex-grow items-center gap-3">
                    <div
                        class="w-10 h-10 rounded-lg bg-blue-100 flex justify-center items-center text-blue-600 font-bold shadow-sm shrink-0">
                        <i class="bi bi-person-fill text-lg"></i>
                    </div>
                    <div class="flex-grow min-w-0">
                        <h3 class="font-bold text-gray-800 text-sm truncate" id="dispCustName">Customer Name</h3>
                        <p class="text-xs text-gray-500 font-mono" id="dispCustPhone">077-1234567</p>
                    </div>
                </div>

                <button onclick="clearCart()"
                    class="text-gray-400 hover:text-red-500 transition-colors p-2 rounded-lg hover:bg-red-50 shrink-0 ml-2"
                    title="Clear Transaction">
                    <i class="bi bi-trash3 text-lg"></i>
                </button>
            </div>

            <!-- Cart Items -->
            <div class="flex-grow p-6 content-start bg-slate-50 space-y-3 overflow-y-auto" id="cartItemsContainer">
                <!-- Empty State -->
                <div id="cartEmptyState"
                    class="h-full flex flex-col justify-center items-center text-gray-400 opacity-60">
                    <i class="bi bi-cart4 text-6xl mb-4 text-gray-300"></i>
                    <p class="font-medium">No active bill selected</p>
                    <p class="text-xs mt-2">Search customer or select pending bill</p>
                </div>
            </div>

            <!-- Totals & Actions -->
            <div class="bg-white border-t border-gray-200 p-6 shadow-[0_-5px_20px_rgba(0,0,0,0.05)] relative z-30">
                <div class="space-y-3 text-sm text-gray-500 mb-6">
                    <div class="flex justify-between">
                        <span>Subtotal</span>
                        <span id="txtSubtotal" class="font-mono font-medium text-gray-800">0.00</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Discount</span>
                        <span class="text-red-500 font-mono">- 0.00</span>
                    </div>
                    <div class="flex justify-between text-lg pt-3 border-t border-dashed border-gray-200">
                        <span class="font-bold text-gray-800">Total Payable</span>
                        <span class="font-bold text-2xl text-basic" id="txtTotal">0.00</span>
                    </div>
                </div>

                <!-- Payment Methods -->
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <button
                        class="py-2.5 border border-gray-200 bg-gray-50 rounded-lg text-sm font-semibold text-gray-600 hover:bg-blue-50 hover:border-blue-200 hover:text-blue-600 focus:ring-2 focus:ring-blue-500 transition-all flex items-center justify-center gap-2">
                        <i class="bi bi-cash coin"></i> Cash
                    </button>
                    <button
                        class="py-2.5 border border-gray-200 bg-gray-50 rounded-lg text-sm font-semibold text-gray-600 hover:bg-blue-50 hover:border-blue-200 hover:text-blue-600 focus:ring-2 focus:ring-blue-500 transition-all flex items-center justify-center gap-2">
                        <i class="bi bi-credit-card"></i> Card
                    </button>
                </div>

                <div class="grid grid-cols-4 gap-3">
                    <button onclick="holdBill()" id="btnHold" disabled
                        class="col-span-1 py-4 bg-orange-50 text-orange-600 font-bold rounded-xl border border-orange-100 hover:bg-orange-100 disabled:opacity-50 disabled:cursor-not-allowed transition-all flex flex-col justify-center items-center text-[10px] uppercase gap-1">
                        <i class="bi bi-pause-fill text-xl"></i> Hold
                    </button>
                    <button onclick="processCheckout()" id="btnCheckout" disabled
                        class="col-span-3 py-4 bg-basic text-white text-base font-bold rounded-xl shadow-lg hover:shadow-xl hover:bg-[#1a3b75] disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none transition-all flex justify-center items-center gap-2 group">
                        <span>PAY & PRINT</span>
                        <i class="bi bi-printer group-hover:translate-x-1 transition-transform"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Held Bills Modal -->
    <div id="heldBillsModal"
        class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden transform transition-all scale-100">
            <div class="bg-gray-50 px-6 py-4 border-b flex justify-between items-center">
                <h3 class="text-lg font-bold text-gray-800">Held Transactions</h3>
                <button onclick="closeHeldModal()" class="text-gray-400 hover:text-gray-600 rounded-full p-1"><i
                        class="bi bi-x-lg"></i></button>
            </div>

            <div id="heldBillsList" class="flex flex-col gap-2 max-h-[60vh] p-6">
                <!-- Items injected here -->
                <p class="text-center text-gray-500 py-4">No held bills found.</p>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../../scripts/common.js"></script>
    <script>
        // --- State ---
        let cart = {
            customer: null,
            items: [],
            total: 0
        };

        // --- Data Mockups (Will replace with LocalStorage) ---
        let pendingBills = [];

        function loadData() {
            // LOAD PENDING BILLS
            const pets = JSON.parse(localStorage.getItem('pets')) || [];
            const opdEntries = JSON.parse(localStorage.getItem('opd_entries')) || [];

            const grouped = {};

            opdEntries.forEach(entry => {
                if (entry.status !== 'Paid') {
                    // Determine Type Label
                    let typeLabel = 'OPD';
                    let typeClass = 'bg-blue-100 text-blue-700'; // Default styling

                    if (entry.type) {
                        typeLabel = entry.type;
                        if (typeLabel === 'Salon') typeClass = 'bg-purple-100 text-purple-700';
                        if (typeLabel === 'Pharmacy') typeClass = 'bg-green-100 text-green-700';
                    } else if (entry.code && entry.code.startsWith('SAL')) {
                        typeLabel = 'Salon';
                        typeClass = 'bg-purple-100 text-purple-700';
                    } else if (entry.code && entry.code.startsWith('PHARM')) {
                        typeLabel = 'Pharmacy';
                        typeClass = 'bg-green-100 text-green-700';
                    }

                    if (!grouped[entry.petId]) {
                        // Attempt to find pet and mock phone if missing
                        const pet = pets.find(p => p.code === entry.petId) || { name: entry.petId || 'Unknown', owner: 'Unknown', phone: '' };
                        // Mock phone if missing for demo
                        if (!pet.phone || pet.phone === '') {
                            // Deterministic mock based on petId length or something, or just random
                            pet.phone = '077-' + Math.floor(1000000 + Math.random() * 9000000);
                        }

                        grouped[entry.petId] = {
                            petId: entry.petId,
                            petName: pet.name,
                            owner: pet.owner,
                            phone: pet.phone,
                            totalAcc: 0,
                            count: 0,
                            bills: []
                        };
                    }
                    floatTotal = parseFloat(entry.totalAmount || 0);
                    grouped[entry.petId].totalAcc += floatTotal;
                    grouped[entry.petId].count++;
                    grouped[entry.petId].bills.push({
                        id: entry.code,
                        desc: `${typeLabel} Bill #${entry.code}`,
                        subtext: entry.visitDate || 'Today',
                        typeLabel: typeLabel,
                        typeClass: typeClass,
                        price: floatTotal,
                        advance: parseFloat(entry.advanceAmount || 0),
                        originalData: entry
                    });
                }
            });

            pendingBills = Object.values(grouped);
        }

        // --- Render Logic ---
        function renderGrid(filter = '') {
            const grid = document.getElementById('gridContainer');
            grid.innerHTML = '';

            const search = filter.toLowerCase();

            const filtered = pendingBills.filter(pb =>
                pb.petName.toLowerCase().includes(search) ||
                pb.petId.toLowerCase().includes(search) ||
                (pb.phone && pb.phone.includes(search)) ||
                (pb.owner && pb.owner.toLowerCase().includes(search))
            );

            if (filtered.length === 0) {
                grid.innerHTML = `<div class="col-span-full flex flex-col items-center justify-center text-gray-400 mt-20 opacity-60">
                    <i class="bi bi-receipt-cutoff text-5xl mb-3"></i>
                    <p>No pending bills found.</p>
                </div>`;
                return;
            }

            filtered.forEach(pb => {
                const card = document.createElement('div');
                card.className = "bg-white p-5 rounded-2xl shadow-sm border border-gray-100 hover:shadow-md hover:border-blue-200 cursor-pointer pos-grid-item flex flex-col justify-between min-h-[200px] h-auto relative group transition-all";
                card.onclick = () => addToCartAsCustomer(pb);

                card.innerHTML = `
                    <div class="absolute top-0 right-0 w-20 h-20 bg-gradient-to-bl from-blue-50 to-transparent rounded-bl-full -mr-10 -mt-10 transition-all group-hover:scale-125"></div>
                    
                    <div class="relative z-10">
                        <div class="flex justify-between items-start mb-3">
                            <div class="bg-gray-100 w-10 h-10 rounded-full flex items-center justify-center text-gray-500 font-bold text-lg">
                                ${pb.petName.charAt(0)}
                            </div>
                            <span class="text-[10px] bg-blue-50 text-blue-600 px-2 py-1 rounded-full font-bold uppercase tracking-wider border border-blue-100">${pb.count} Bills</span>
                        </div>
                        
                        <h3 class="font-bold text-lg text-gray-800 truncate mb-0.5 group-hover:text-blue-600 transition-colors">${pb.petName}</h3>
                        <p class="text-xs text-gray-500 flex items-center gap-1"><i class="bi bi-person"></i> ${pb.owner}</p>
                        <p class="text-[10px] text-gray-400 font-mono mt-1">ID: ${pb.petId}</p>
                        ${pb.phone ? `<p class="text-[10px] text-gray-400 font-mono"><i class="bi bi-telephone"></i> ${pb.phone}</p>` : ''}
                    </div>

                    <div class="relative z-10 mt-4 pt-4 border-t border-gray-50 flex justify-between items-end">
                        <span class="text-xs text-gray-400 font-medium">Total Due</span>
                        <div class="text-right">
                             ${pb.bills.reduce((acc, b) => acc + (b.price - (b.advance || 0)), 0).toFixed(2) !== pb.totalAcc.toFixed(2)
                        ? `<span class="block text-[10px] text-gray-400 line-through decoration-red-300">${pb.totalAcc.toFixed(2)}</span>`
                        : ''}
                             <span class="text-xl font-bold text-gray-800 group-hover:text-basic transition-colors">
                                ${pb.bills.reduce((acc, b) => acc + (b.price - (b.advance || 0)), 0).toFixed(2)}
                             </span>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function renderCart() {
            const container = document.getElementById('cartItemsContainer');
            const empty = document.getElementById('cartEmptyState');

            // Toggle Display
            const searchContainer = document.getElementById('customerSearchContainer');
            const displayContainer = document.getElementById('selectedCustomerDisplay');
            const searchInput = document.getElementById('customerSearchInput');

            if (cart.customer) {
                searchContainer.classList.add('hidden');
                displayContainer.classList.remove('hidden');
                displayContainer.classList.add('flex');

                document.getElementById('dispCustName').innerText = cart.customer.petName + " (" + cart.customer.owner + ")";
                document.getElementById('dispCustPhone').innerText = cart.customer.phone || cart.customer.petId;
            } else {
                searchContainer.classList.remove('hidden');
                displayContainer.classList.add('hidden');
                displayContainer.classList.remove('flex');
                searchInput.value = ''; // Reset input on clear
            }

            // Items
            if (cart.items.length === 0) {
                container.innerHTML = '';
                container.appendChild(empty);
                updateTotals();
                return;
            } else {
                if (container.contains(empty)) container.removeChild(empty);
            }

            container.innerHTML = '';
            cart.items.forEach((item, index) => {
                const row = document.createElement('div');
                row.className = "flex justify-between items-start p-4 bg-white border border-gray-100 rounded-xl shadow-sm hover:border-gray-300 transition-all group shrink-0";

                row.innerHTML = `
                    <div class="flex-grow pr-4">
                        <div class="flex items-center gap-2 mb-1">
                             <span class="text-[10px] px-1.5 py-0.5 rounded font-bold uppercase tracking-wider ${item.typeClass || 'bg-gray-100 text-gray-600'}">${item.typeLabel || 'BILL'}</span>
                             <h5 class="text-sm font-bold text-gray-800 leading-tight">${item.desc}</h5>
                        </div>
                        <div class="text-xs text-gray-500 pl-1">
                            ${item.subtext || ''}
                        </div>
                    </div>
                    <div class="text-right flex flex-col items-end justify-between self-stretch">
                        <div>
                            <span class="font-bold text-gray-900 font-mono block">${(item.price - (item.advance || 0)).toFixed(2)}</span>
                            ${item.advance > 0 ? `<span class="text-[10px] text-green-600 bg-green-50 px-1 rounded block mt-0.5">Paid: ${item.advance.toFixed(2)}</span>` : ''}
                        </div>
                        <button onclick="removeFromCart(${index})" class="text-xs text-red-400 opacity-0 group-hover:opacity-100 hover:text-red-600 font-medium transition-opacity flex items-center gap-1 mt-auto">
                            <i class="bi bi-x-circle"></i> Remove
                        </button>
                    </div>
                `;
                container.appendChild(row);
            });

            updateTotals();
        }

        // --- Actions ---
        function handleSearch() {
            renderGrid(document.getElementById('searchInput').value);
        }

        function searchCustomer(query) {
            const results = document.getElementById('customerSearchResults');
            const clearIcon = document.getElementById('searchClearIcon');
            const container = document.getElementById('customerSearchContainer');

            if (!query) {
                results.classList.add('hidden');
                clearIcon.style.display = 'none';
                return;
            }

            clearIcon.style.display = 'block';
            results.classList.remove('hidden');

            const lower = query.toLowerCase();
            // Filter from pendingBills (as we only want people with bills)
            const matches = pendingBills.filter(pb =>
                pb.petName.toLowerCase().includes(lower) ||
                (pb.owner && pb.owner.toLowerCase().includes(lower)) ||
                (pb.phone && pb.phone.includes(lower)) ||
                pb.petId.toLowerCase().includes(lower)
            );

            results.innerHTML = '';

            if (matches.length === 0) {
                results.innerHTML = `<div class="px-4 py-3 text-sm text-gray-500 text-center">No pending bills found for query.</div>`;
            } else {
                matches.forEach(m => {
                    const div = document.createElement('div');
                    div.className = "px-4 py-3 hover:bg-gray-50 cursor-pointer border-b border-gray-50 last:border-0 flex justify-between items-center";
                    div.onclick = () => {
                        addToCartAsCustomer(m);
                        clearCustomerSearch();
                    };
                    div.innerHTML = `
                        <div>
                            <p class="font-bold text-gray-800 text-sm">${m.petName} <span class="text-xs font-normal text-gray-500">(${m.owner})</span></p>
                            <p class="text-xs text-gray-400 font-mono">${m.phone || 'No Phone'}</p>
                        </div>
                        <div class="text-right">
                             <span class="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded-full">${m.count} Bills</span>
                             <p class="text-xs font-bold text-gray-800 mt-1">${m.totalAcc.toFixed(2)}</p>
                        </div>
                    `;
                    results.appendChild(div);
                });
            }
        }

        function clearCustomerSearch() {
            document.getElementById('customerSearchInput').value = '';
            document.getElementById('customerSearchResults').classList.add('hidden');
            document.getElementById('searchClearIcon').style.display = 'none';
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function (e) {
            const container = document.getElementById('customerSearchContainer');
            if (container && !container.contains(e.target)) {
                document.getElementById('customerSearchResults').classList.add('hidden');
            }
        });

        // --- Cart Logic ---
        function addToCartAsCustomer(pendingBillGroup) {
            // Check if same customer
            if (cart.customer && cart.customer.petId === pendingBillGroup.petId) {
                return; // Already selected
            }

            // If another customer selected, confirm
            if (cart.customer) {
                if (!confirm("Switching customer will clear the current cart. Continue?")) {
                    return;
                }
                clearCart();
            }

            cart.customer = {
                petId: pendingBillGroup.petId,
                petName: pendingBillGroup.petName,
                owner: pendingBillGroup.owner,
                phone: pendingBillGroup.phone
            };

            // Add all bills from this group
            pendingBillGroup.bills.forEach(bill => {
                // check if already adds
                const exists = cart.items.find(i => i.id === bill.id);
                if (!exists) {
                    cart.items.push({
                        id: bill.id,
                        desc: bill.desc,
                        subtext: bill.subtext,
                        typeLabel: bill.typeLabel,
                        typeClass: bill.typeClass,
                        price: bill.price,
                        advance: bill.advance,
                        type: 'bill', // distinction
                        originalData: bill.originalData
                    });
                }
            });

            renderCart();
            clearCustomerSearch();
        }

        function removeFromCart(index) {
            cart.items.splice(index, 1);
            if (cart.items.length === 0) {
                cart.customer = null;
            }
            renderCart();
        }

        function clearCart() {
            cart = {
                customer: null,
                items: [],
                total: 0
            };
            clearCustomerSearch();
            renderCart();
        }

        function updateTotals() {
            let sub = 0;
            cart.items.forEach(i => sub += (i.price - (i.advance || 0)));
            cart.total = sub;

            document.getElementById('txtSubtotal').innerText = sub.toFixed(2);
            document.getElementById('txtTotal').innerText = sub.toFixed(2);

            const btn = document.getElementById('btnCheckout');
            const btnHold = document.getElementById('btnHold');

            if (cart.items.length > 0) {
                btn.disabled = false;
                btnHold.disabled = false;
            } else {
                btn.disabled = true;
                btnHold.disabled = true;
            }
        }

        // --- Held Bill Logic ---
        function holdBill() {
            if (cart.items.length === 0) return;

            const heldBills = JSON.parse(localStorage.getItem('held_bills')) || [];

            const newHold = {
                id: 'HOLD_' + Date.now(),
                timestamp: new Date().toISOString(),
                cart: cart
            };

            heldBills.push(newHold);
            localStorage.setItem('held_bills', JSON.stringify(heldBills));

            clearCart();
            updateHeldBadge();
            // alert("Bill Held Successfully!");
        }

        function updateHeldBadge() {
            const heldBills = JSON.parse(localStorage.getItem('held_bills')) || [];
            const badge = document.getElementById('heldCountBadge');

            if (heldBills.length > 0) {
                badge.textContent = heldBills.length;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        function showHeldBills() {
            const heldBills = JSON.parse(localStorage.getItem('held_bills')) || [];
            const list = document.getElementById('heldBillsList');
            const modal = document.getElementById('heldBillsModal');

            list.innerHTML = '';

            if (heldBills.length === 0) {
                list.innerHTML = '<div class="flex flex-col items-center justify-center py-8 text-gray-400"><i class="bi bi-inbox text-4xl mb-2"></i><p>No held bills found.</p></div>';
            } else {
                heldBills.forEach((bill, index) => {
                    const item = document.createElement('div');
                    item.className = "p-4 border border-gray-100 rounded-xl bg-gray-50 hover:bg-white hover:shadow-md transition-all flex justify-between items-center group";
                    item.innerHTML = `
                        <div>
                            <p class="font-bold text-gray-800 text-sm">${bill.cart.customer ? bill.cart.customer.petName : 'Walk-in'}</p>
                            <p class="text-xs text-gray-400 mt-0.5">${new Date(bill.timestamp).toLocaleString()}</p>
                            <p class="text-xs font-bold text-blue-600 mt-1">${bill.cart.items.length} Items - ${bill.cart.total.toFixed(2)}</p>
                        </div>
                        <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="restoreHeldBill('${bill.id}')" class="px-3 py-1.5 bg-blue-600 text-white text-xs rounded-lg font-bold hover:bg-blue-700 shadow-sm">Restore</button>
                            <button onclick="deleteHeldBill('${bill.id}')" class="px-3 py-1.5 bg-red-100 text-red-600 text-xs rounded-lg font-bold hover:bg-red-200">Delete</button>
                        </div>
                    `;
                    list.appendChild(item);
                });
            }

            modal.classList.remove('hidden');
        }

        function closeHeldModal() {
            document.getElementById('heldBillsModal').classList.add('hidden');
        }

        function restoreHeldBill(holdId) {
            // Check if current cart has items
            if (cart.items.length > 0) {
                if (!confirm("Current active cart isn't empty. Replace it with held bill?")) {
                    return;
                }
            }

            const heldBills = JSON.parse(localStorage.getItem('held_bills')) || [];
            const billIndex = heldBills.findIndex(b => b.id === holdId);

            if (billIndex !== -1) {
                const bill = heldBills[billIndex];
                cart = bill.cart;

                // Remove from held list
                heldBills.splice(billIndex, 1);
                localStorage.setItem('held_bills', JSON.stringify(heldBills));

                renderCart();
                updateHeldBadge();
                closeHeldModal();
            }
        }

        function deleteHeldBill(holdId) {
            if (!confirm("Delete this held bill permanently?")) return;

            const heldBills = JSON.parse(localStorage.getItem('held_bills')) || [];
            const updated = heldBills.filter(b => b.id !== holdId);

            localStorage.setItem('held_bills', JSON.stringify(updated));
            showHeldBills(); // Refresh list
            updateHeldBadge();
        }

        function processCheckout() {
            if (confirm("Process Payment of LKR " + cart.total.toFixed(2) + " and Print Receipt?")) {
                // Logic to mark bills as paid
                const opdEntries = JSON.parse(localStorage.getItem('opd_entries')) || [];
                let paidCount = 0;

                cart.items.forEach(item => {
                    if (item.type === 'bill') {
                        const idx = opdEntries.findIndex(e => e.code === item.id);
                        if (idx !== -1) {
                            opdEntries[idx].status = 'Paid';
                            opdEntries[idx].paidAt = new Date().toISOString();
                            paidCount++;
                        }
                    }
                });

                if (paidCount > 0) {
                    localStorage.setItem('opd_entries', JSON.stringify(opdEntries));
                }

                // Custom Alert or Toast could be better
                alert("Payment Successful! Receipt Sent to Printer.");

                // Refresh Data
                clearCart();
                loadData();
                renderGrid();
            }
        }

        // Init
        loadData();
        renderGrid();
        updateHeldBadge();
    </script>
    <footer class="mt-auto bg-basic py-4 text-center text-white text-xs w-full">
        <p>2026 Â© All Rights Reserved | Royal Pets Animal Hospital | Designed and Developed by Silicon Radon Networks
            (Pvt) Ltd</p>
    </footer>
</body>

</html>