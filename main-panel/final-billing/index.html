<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Application | Final Billing POS</title>
    <link rel="icon" href="../../images/favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../../styles/common.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        .pos-grid-item {
            transition: all 0.2s;
        }

        .pos-grid-item:active {
            transform: scale(0.95);
        }

        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;
            /* IE and Edge */
            scrollbar-width: none;
            /* Firefox */
        }
    </style>
</head>

<body class="h-screen w-screen overflow-hidden bg-gray-100 flex text-gray-800">

    <!-- LEFT PANEL: Items / Services / Pending Bills (70%) -->
    <div class="flex-grow flex flex-col h-full border-r border-gray-300">
        <!-- Header -->
        <div class="h-16 bg-white border-b border-gray-200 flex justify-between items-center px-6 shadow-sm z-10">
            <div class="flex items-center gap-4">
                <button onclick="window.location.href = '../';"
                    class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                    <i class="bi bi-arrow-left text-2xl text-gray-600"></i>
                </button>
                <h1 class="text-xl font-bold text-gray-700 uppercase tracking-wide">Final Billing <span
                        class="text-basic">POS</span></h1>
            </div>

            <!-- Tabs Removed -->
            <div class="flex items-center gap-4 bg-gray-50 px-4 py-2 rounded-full shadow-inner border">
                <i class="bi bi-clock-history text-blue-600"></i>
                <span class="font-bold text-gray-700 text-sm">Pending Bills</span>
            </div>

            <div class="flex items-center gap-4">
                <button onclick="showHeldBills()"
                    class="relative p-2 text-gray-500 hover:text-blue-600 transition-colors">
                    <i class="bi bi-pause-circle text-2xl"></i>
                    <span id="heldCountBadge"
                        class="hidden absolute top-0 right-0 w-4 h-4 bg-red-500 text-white text-[10px] font-bold rounded-full flex justify-center items-center">0</span>
                </button>
                <div class="relative">
                    <i class="bi bi-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="searchInput" onkeyup="handleSearch()" placeholder="Search..."
                        class="pl-10 pr-4 py-2 border border-gray-300 rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 w-64 bg-gray-50">
                </div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="flex-grow bg-gray-50 overflow-y-auto p-6" id="mainContent">
            <!-- Dynamic Content Injected Here -->
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" id="gridContainer">
                <!-- Grid Items -->
            </div>
        </div>
    </div>

    <!-- RIGHT PANEL: Cart / Transaction (30%) -->
    <div class="w-[400px] bg-white flex flex-col h-full shadow-2xl z-20">
        <!-- Customer Info -->
        <div class="h-16 bg-blue-50 border-b border-blue-100 flex items-center px-4 justify-between">
            <div class="flex items-center gap-3">
                <div
                    class="w-10 h-10 rounded-full bg-blue-200 flex justify-center items-center text-blue-700 font-bold">
                    <i class="bi bi-person-fill"></i>
                </div>
                <div>
                    <h3 class="font-bold text-sm text-gray-800" id="cartCustomerName">No Customer Selected</h3>
                    <p class="text-xs text-gray-500" id="cartCustomerId">ID: --</p>
                </div>
            </div>
            <button onclick="clearCart()" class="text-red-500 hover:text-red-700 text-sm font-medium">
                <i class="bi bi-trash"></i> Clear
            </button>
        </div>

        <!-- Cart Items -->
        <div class="flex-grow overflow-y-auto p-4 content-start" id="cartItemsContainer">
            <!-- Empty State -->
            <div id="cartEmptyState" class="h-full flex flex-col justify-center items-center text-gray-400 opacity-60">
                <i class="bi bi-cart4 text-6xl mb-2"></i>
                <p>Cart is Empty</p>
            </div>
        </div>

        <!-- Totals & Actions -->
        <div class="bg-gray-50 border-t border-gray-200 p-4">
            <div class="space-y-2 text-sm text-gray-600 mb-4">
                <div class="flex justify-between">
                    <span>Subtotal</span>
                    <span id="txtSubtotal">0.00</span>
                </div>
                <div class="flex justify-between">
                    <span>Discount</span>
                    <span class="text-red-500">- 0.00</span>
                </div>
                <div class="flex justify-between">
                    <span>Tax (0%)</span>
                    <span>0.00</span>
                </div>
            </div>

            <div class="flex justify-between items-center mb-4 pt-4 border-t border-gray-200">
                <span class="font-bold text-xl text-gray-800">TOTAL</span>
                <span class="font-bold text-3xl text-basic" id="txtTotal">0.00</span>
            </div>

            <!-- Payment Methods -->
            <div class="grid grid-cols-2 gap-2 mb-4">
                <button
                    class="py-2 border border-gray-300 rounded-md text-sm font-medium hover:bg-gray-100 focus:ring-2 focus:ring-blue-500 active:bg-blue-50">
                    <i class="bi bi-cash coin"></i> Cash
                </button>
                <button
                    class="py-2 border border-gray-300 rounded-md text-sm font-medium hover:bg-gray-100 focus:ring-2 focus:ring-blue-500 active:bg-blue-50">
                    <i class="bi bi-credit-card"></i> Card
                </button>
            </div>

            <div class="grid grid-cols-4 gap-2">
                <button onclick="holdBill()" id="btnHold" disabled
                    class="col-span-1 py-4 bg-orange-100 text-orange-600 font-bold rounded-lg hover:bg-orange-200 disabled:opacity-50 disabled:cursor-not-allowed transition-all flex flex-col justify-center items-center text-xs">
                    <i class="bi bi-pause-fill text-xl"></i> HOLD
                </button>
                <button onclick="processCheckout()" id="btnCheckout" disabled
                    class="col-span-3 py-4 bg-basic text-white text-lg font-bold rounded-lg shadow-lg hover:bg-opacity-90 disabled:opacity-50 disabled:cursor-not-allowed transition-all flex justify-center items-center gap-2">
                    PAY & PRINT BILL
                </button>
            </div>
        </div>
    </div>

    <!-- Held Bills Modal -->
    <div id="heldBillsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-xl font-bold text-gray-800">Held Bills</h3>
                <button onclick="closeHeldModal()" class="text-gray-400 hover:text-gray-600"><i
                        class="bi bi-x-lg"></i></button>
            </div>
            <div id="heldBillsList" class="flex flex-col gap-2 max-h-[60vh] overflow-y-auto">
                <!-- Items injected here -->
                <p class="text-center text-gray-500 py-4">No held bills found.</p>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../../scripts/common.js"></script>
    <script>
        // --- State ---
        // --- State ---
        let cart = {
            customer: null,
            items: [],
            total: 0
        };

        // --- Data Mockups (Will replace with LocalStorage) ---
        let pendingBills = [];

        function loadData() {
            // LOAD PENDING BILLS
            const pets = JSON.parse(localStorage.getItem('pets')) || [];
            const opdEntries = JSON.parse(localStorage.getItem('opd_entries')) || [];

            const grouped = {};

            opdEntries.forEach(entry => {
                if (entry.status !== 'Paid') {
                    if (!grouped[entry.petId]) {
                        const pet = pets.find(p => p.code === entry.petId) || { name: 'Unknown', owner: 'Unknown' };
                        grouped[entry.petId] = {
                            petId: entry.petId,
                            petName: pet.name,
                            owner: pet.owner,
                            totalAcc: 0,
                            count: 0,
                            bills: []
                        };
                    }
                    floatTotal = parseFloat(entry.totalAmount || 0);
                    grouped[entry.petId].totalAcc += floatTotal;
                    grouped[entry.petId].count++;
                    grouped[entry.petId].bills.push({
                        id: entry.code,
                        desc: `OPD Bill #${entry.code} - ${entry.visitDate || 'N/A'}`,
                        price: floatTotal,
                        originalData: entry
                    });
                }
            });

            pendingBills = Object.values(grouped);

            pendingBills = Object.values(grouped);
        }

        // --- Render Logic ---
        // --- Render Logic ---
        function renderGrid(filter = '') {
            const grid = document.getElementById('gridContainer');
            grid.innerHTML = '';

            const search = filter.toLowerCase();

            const filtered = pendingBills.filter(pb =>
                pb.petName.toLowerCase().includes(search) ||
                pb.petId.toLowerCase().includes(search)
            );

            if (filtered.length === 0) {
                grid.innerHTML = `<div class="col-span-full text-center text-gray-400 mt-10">
                    <i class="bi bi-clipboard-check text-4xl mb-2"></i>
                    <p>No pending bills found.</p>
                </div>`;
                return;
            }

            filtered.forEach(pb => {
                const card = document.createElement('div');
                card.className = "bg-white p-4 rounded-xl shadow-sm border border-gray-200 hover:shadow-md cursor-pointer pos-grid-item flex flex-col justify-between h-[180px] border-l-4 border-l-blue-500";
                card.onclick = () => addToCartAsCustomer(pb);

                card.innerHTML = `
                    <div>
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-bold text-lg text-gray-800 truncate">${pb.petName}</h3>
                            <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full font-bold">${pb.count} Bills</span>
                        </div>
                        <p class="text-sm text-gray-500 mb-1"><i class="bi bi-person"></i> ${pb.owner}</p>
                        <p class="text-xs text-gray-400">ID: ${pb.petId}</p>
                    </div>
                    <div class="mt-4 pt-4 border-t border-dashed border-gray-200 flex justify-between items-end">
                        <span class="text-xs text-gray-500">Total Due</span>
                        <span class="text-xl font-bold text-gray-900">${pb.totalAcc.toFixed(2)}</span>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function renderCart() {
            const container = document.getElementById('cartItemsContainer');
            const empty = document.getElementById('cartEmptyState');

            // Customer Header
            if (cart.customer) {
                document.getElementById('cartCustomerName').innerText = cart.customer.petName;
                document.getElementById('cartCustomerId').innerText = "ID: " + cart.customer.petId;
            } else {
                document.getElementById('cartCustomerName').innerText = "Walk-in Customer";
                document.getElementById('cartCustomerId').innerText = "";
            }

            // Items
            if (cart.items.length === 0) {
                container.innerHTML = '';
                container.appendChild(empty);
                updateTotals();
                return;
            } else {
                if (container.contains(empty)) container.removeChild(empty);
            }

            container.innerHTML = '';
            cart.items.forEach((item, index) => {
                const row = document.createElement('div');
                row.className = "flex justify-between items-center mb-3 p-3 bg-white border border-gray-100 rounded-lg shadow-sm group hover:border-blue-200";

                row.innerHTML = `
                    <div class="flex-grow">
                        <h5 class="text-sm font-semibold text-gray-800 leading-tight">${item.desc}</h5>
                        <div class="text-xs text-gray-500 mt-1">
                            ${item.qty ? `Rate: ${item.unitPrice} x ${item.qty}` : 'Flat Rate'}
                        </div>
                    </div>
                    <div class="text-right flex flex-col items-end">
                        <span class="font-bold text-gray-900">${item.price.toFixed(2)}</span>
                        <button onclick="removeFromCart(${index})" class="text-xs text-red-400 opacity-0 group-hover:opacity-100 hover:text-red-600 mt-1 font-medium">Remove</button>
                    </div>
                `;
                container.appendChild(row);
            });

            updateTotals();
        }

        // --- Actions ---
        function handleSearch() {
            renderGrid(document.getElementById('searchInput').value);
        }

        // --- Cart Logic ---
        function addToCartAsCustomer(pendingBillGroup) {
            // If another customer selected, warn or switch?
            if (cart.customer && cart.customer.petId !== pendingBillGroup.petId) {
                if (!confirm("This will clear the current cart for " + cart.customer.petName + ". Continue?")) {
                    return;
                }
                clearCart();
            }

            cart.customer = {
                petId: pendingBillGroup.petId,
                petName: pendingBillGroup.petName,
                owner: pendingBillGroup.owner
            };

            // Add all bills from this group
            pendingBillGroup.bills.forEach(bill => {
                // check if already adds
                const exists = cart.items.find(i => i.id === bill.id);
                if (!exists) {
                    cart.items.push({
                        id: bill.id,
                        desc: bill.desc,
                        price: bill.price,
                        type: 'bill', // distinction
                        originalData: bill.originalData
                    });
                }
            });

            renderCart();
        }



        function removeFromCart(index) {
            cart.items.splice(index, 1);
            if (cart.items.length === 0) {
                // optionally clear customer if empty
                // cart.customer = null; 
            }
            renderCart();
        }

        function clearCart() {
            cart = {
                customer: null,
                items: [],
                total: 0
            };
            renderCart();
        }

        function updateTotals() {
            let sub = 0;
            cart.items.forEach(i => sub += i.price);
            cart.total = sub;

            document.getElementById('txtSubtotal').innerText = sub.toFixed(2);
            document.getElementById('txtTotal').innerText = sub.toFixed(2);

            const btn = document.getElementById('btnCheckout');
            const btnHold = document.getElementById('btnHold');

            if (cart.items.length > 0) {
                btn.disabled = false;
                btnHold.disabled = false;
            } else {
                btn.disabled = true;
                btnHold.disabled = true;
            }
        }

        // --- Held Bill Logic ---
        function holdBill() {
            if (cart.items.length === 0) return;

            const heldBills = JSON.parse(localStorage.getItem('held_bills')) || [];

            const newHold = {
                id: 'HOLD_' + Date.now(),
                timestamp: new Date().toISOString(),
                cart: cart
            };

            heldBills.push(newHold);
            localStorage.setItem('held_bills', JSON.stringify(heldBills));

            clearCart();
            updateHeldBadge();
            alert("Bill Held Successfully!");
        }

        function updateHeldBadge() {
            const heldBills = JSON.parse(localStorage.getItem('held_bills')) || [];
            const badge = document.getElementById('heldCountBadge');

            if (heldBills.length > 0) {
                badge.textContent = heldBills.length;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        function showHeldBills() {
            const heldBills = JSON.parse(localStorage.getItem('held_bills')) || [];
            const list = document.getElementById('heldBillsList');
            const modal = document.getElementById('heldBillsModal');

            list.innerHTML = '';

            if (heldBills.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-500 py-4">No held bills found.</p>';
            } else {
                heldBills.forEach((bill, index) => {
                    const item = document.createElement('div');
                    item.className = "p-3 border rounded-lg bg-gray-50 flex justify-between items-center hover:bg-gray-100";
                    item.innerHTML = `
                        <div>
                            <p class="font-bold text-gray-800">${bill.cart.customer ? bill.cart.customer.petName : 'Walk-in'}</p>
                            <p class="text-xs text-gray-500">${new Date(bill.timestamp).toLocaleString()}</p>
                            <p class="text-xs font-semibold text-blue-600">${bill.cart.items.length} Items - ${bill.cart.total.toFixed(2)}</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="restoreHeldBill('${bill.id}')" class="px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">Restore</button>
                            <button onclick="deleteHeldBill('${bill.id}')" class="px-3 py-1 bg-red-100 text-red-600 text-xs rounded hover:bg-red-200"><i class="bi bi-trash"></i></button>
                        </div>
                    `;
                    list.appendChild(item);
                });
            }

            modal.classList.remove('hidden');
        }

        function closeHeldModal() {
            document.getElementById('heldBillsModal').classList.add('hidden');
        }

        function restoreHeldBill(holdId) {
            // Check if current cart has items
            if (cart.items.length > 0) {
                if (!confirm("Current cart is not empty. Overwrite with held bill?")) {
                    return;
                }
            }

            const heldBills = JSON.parse(localStorage.getItem('held_bills')) || [];
            const billIndex = heldBills.findIndex(b => b.id === holdId);

            if (billIndex !== -1) {
                const bill = heldBills[billIndex];
                cart = bill.cart;

                // Remove from held list
                heldBills.splice(billIndex, 1);
                localStorage.setItem('held_bills', JSON.stringify(heldBills));

                renderCart();
                updateHeldBadge();
                closeHeldModal();
            }
        }

        function deleteHeldBill(holdId) {
            if (!confirm("Delete this held bill permanently?")) return;

            const heldBills = JSON.parse(localStorage.getItem('held_bills')) || [];
            const updated = heldBills.filter(b => b.id !== holdId);

            localStorage.setItem('held_bills', JSON.stringify(updated));
            showHeldBills(); // Refresh list
            updateHeldBadge();
        }

        function processCheckout() {
            if (confirm("Process Payment of " + cart.total.toFixed(2) + "?")) {
                // Logic to mark bills as paid
                const opdEntries = JSON.parse(localStorage.getItem('opd_entries')) || [];
                let paidCount = 0;

                cart.items.forEach(item => {
                    if (item.type === 'bill') {
                        const idx = opdEntries.findIndex(e => e.code === item.id);
                        if (idx !== -1) {
                            opdEntries[idx].status = 'Paid';
                            opdEntries[idx].paidAt = new Date().toISOString();
                            paidCount++;
                        }
                    }
                });

                if (paidCount > 0) {
                    localStorage.setItem('opd_entries', JSON.stringify(opdEntries));
                }

                alert("Payment Successful!\nReceipt Printing...");

                // Refresh Data
                clearCart();
                loadData();
                renderGrid();
            }
        }

        // Init
        loadData();
        renderGrid();
        updateHeldBadge();
    </script>
</body>

</html>