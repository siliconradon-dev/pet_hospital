<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Daycare Booking Receipt</title>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>
    <style>
        * {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }

        @page {
            size: 72mm auto;
            width: 72mm;
            margin: 25px;
        }

        body {
            font-family: Arial, sans-serif;
            font-size: 11px;
            margin: 0px !important;
            padding: 0px;
            width: 72mm;
            max-width: 300px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }

        .center {
            text-align: center;
        }

        .bold {
            font-weight: bold;
        }

        .bolder {
            font-weight: bolder;
        }

        .small {
            font-size: 10px;
        }

        .text-xs {
            font-size: 7px;
            display: inline-block;
            margin: 0;
            padding: 0;
        }

        .line {
            border-bottom: 1px solid #000;
            margin: 2px 0;
            width: 100%;
        }

        .underline {
            border-bottom: 1px solid #000;
            display: inline-block;
            width: 100%;
            margin: 2px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: inherit;
        }

        td {
            padding: 1px 2px;
            vertical-align: top;
        }

        .info-row td {
            padding: 1px 0;
        }

        .item-header {
            font-size: 9px;
            font-weight: bold;
        }

        .item-row td {
            padding: 1px 0;
        }

        .total-section {
            margin-top: 3px;
        }

        .footer {
            margin-top: 5px;
            font-size: 9px;
        }

        .capitalize {
            text-transform: capitalize !important;
        }

        table,
        td,
        div,
        span {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        #barcodeImage {
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
        }

        .footer-pr {
            padding-right: 8px;
        }

        .item-total-pr {
            padding-right: 6px;
        }

        @media print {
            body {
                width: 72mm;
            }
        }
    </style>
</head>

<body>
    <div id="invoice">
        <!-- Company Info -->
        <div class="center bolder capitalize" style="font-size: 17px; text-transform: capitalize;">
            Pet Hospital
        </div>

        <div class="center" style="font-size: 12px;">
            Daycare Services
        </div>

        <div class="center" style="font-size: 14px;">
            Tel: +94 123 456 789
        </div>

        <div class="center bold p-0 m-0">BOOKING: <span id="bookingCode"></span></div>
        <div class="center"><img id="barcodeImage" class="object-fill w-full h-full" alt="Barcode"></div>

        <!-- Booking Information -->
        <table style="font-size: 9px; width: 100%; margin-top: 5px;">
            <tr>
                <td style="width: 25%;">DATE:</td>
                <td style="width: 75%;" id="bookingDate"></td>
            </tr>
            <tr>
                <td>PET:</td>
                <td id="petName"></td>
            </tr>
            <tr>
                <td>PET CODE:</td>
                <td id="petCode"></td>
            </tr>
            <tr>
                <td>START:</td>
                <td id="startDate"></td>
            </tr>
            <tr>
                <td>RETURN:</td>
                <td id="endDate"></td>
            </tr>
            <tr>
                <td>DURATION:</td>
                <td id="duration"></td>
            </tr>
            <tr>
                <td>STATUS:</td>
                <td id="status"></td>
            </tr>
        </table>

        <div class="underline"></div>

        <!-- Base Charge -->
        <div style="font-size: 11px; margin: 5px 0;">
            <table>
                <tr>
                    <td style="width: 60%;">DAYCARE SERVICE</td>
                    <td style="width: 10%;"></td>
                    <td class="footer-pr" style="width: 30%; text-align: right;" id="baseCharge"></td>
                </tr>
            </table>
        </div>

        <!-- Food Items Section -->
        <div id="foodSection" style="display: none;">
            <div style="font-size: 10px; font-weight: bold; margin-top: 5px;">FOOD ITEMS:</div>
            <div id="foodItems" style="font-size: 9px;"></div>
        </div>

        <!-- Medicine Items Section -->
        <div id="medicineSection" style="display: none;">
            <div style="font-size: 10px; font-weight: bold; margin-top: 5px;">MEDICINE ITEMS:</div>
            <div id="medicineItems" style="font-size: 9px;"></div>
        </div>

        <!-- Notes Section -->
        <div id="notesSection" style="display: none; margin-top: 5px;">
            <div style="font-size: 10px; font-weight: bold;">NOTES:</div>
            <div id="notes" style="font-size: 9px;"></div>
        </div>

        <div class="underline"></div>

        <!-- Totals Section -->
        <div class="total-section">
            <table style="font-size: 11px; width: 100%;">
                <tr>
                    <td style="width: 60%;">BASE CHARGE</td>
                    <td style="width: 5%;">:</td>
                    <td class="footer-pr" style="width: 30%; text-align: right;" id="baseChargeTotal"></td>
                </tr>
                <tr id="foodTotalRow" style="display: none;">
                    <td>FOOD TOTAL</td>
                    <td>:</td>
                    <td class="footer-pr" style="text-align: right;" id="foodTotal"></td>
                </tr>
                <tr id="medicineTotalRow" style="display: none;">
                    <td>MEDICINE TOTAL</td>
                    <td>:</td>
                    <td class="footer-pr" style="text-align: right;" id="medicineTotal"></td>
                </tr>
                <tr id="extraCostsRow" style="display: none;">
                    <td>EXTRA COSTS</td>
                    <td>:</td>
                    <td class="footer-pr" style="text-align: right;" id="extraCosts"></td>
                </tr>
                <tr style="font-weight: bold; font-size: 13px;">
                    <td>TOTAL</td>
                    <td>:</td>
                    <td class="footer-pr" style="text-align: right;" id="grandTotal"></td>
                </tr>
            </table>
        </div>

        <div style="border-bottom: 1px solid #000; margin: 5px 0;"></div>

        <!-- Footer -->
        <div class="footer center">
            <div style="margin: 3px 0;">THANK YOU FOR CHOOSING US!</div>
            <div style="margin: 3px 0;">YOUR PET'S COMFORT IS OUR PRIORITY</div>
            <div style="border-bottom: 1px solid #000; margin: 3px 0;"></div>
            <div id="lastTxt" style="margin: 3px 0; font-size: 8px;" class="bold">Powered by Silicon Radon Networks
                (Pvt) Ltd.</div>
        </div>
    </div>
</body>

<script>
    // Get booking code from URL
    const urlParams = new URLSearchParams(window.location.search);
    const bookingCode = urlParams.get('code');

    // Load booking data
    const bookings = JSON.parse(localStorage.getItem('daycareBookings')) || [];
    const booking = bookings.find(b => b.code === bookingCode);

    if (booking) {
        // Generate Barcode
        const barcodeCanvas = document.createElement("canvas");
        barcodeCanvas.width = barcodeCanvas.width * 2;
        barcodeCanvas.height = barcodeCanvas.height * 2;
        const ctx = barcodeCanvas.getContext('2d');
        ctx.scale(2, 2);

        JsBarcode(barcodeCanvas, bookingCode, {
            format: "CODE128",
            width: 1,
            height: 15,
            displayValue: false,
            margin: 0,
            fontSize: 0
        });

        document.getElementById("barcodeImage").src = barcodeCanvas.toDataURL("image/png");

        // Calculate duration
        const startDate = new Date(booking.startDate);
        const endDate = new Date(booking.endDate);
        const duration = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
        const baseCharge = duration * 50;

        // Populate basic info
        document.getElementById('bookingCode').textContent = bookingCode;
        document.getElementById('bookingDate').textContent = new Date(booking.createdDate).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        document.getElementById('petName').textContent = booking.petName;
        document.getElementById('petCode').textContent = booking.petCode;
        document.getElementById('startDate').textContent = new Date(booking.startDate).toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        document.getElementById('endDate').textContent = new Date(booking.endDate).toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        document.getElementById('duration').textContent = duration + ' DAY(S) @ Rs. 50/DAY';
        document.getElementById('status').textContent = booking.status.toUpperCase();
        document.getElementById('baseCharge').textContent = 'Rs. ' + baseCharge.toFixed(2);

        // Food items
        if (booking.foodItems && booking.foodItems.length > 0) {
            document.getElementById('foodSection').style.display = 'block';
            document.getElementById('foodTotalRow').style.display = 'table-row';
            
            const foodItemsHtml = booking.foodItems.map(item => `
                <table style="margin: 2px 0;">
                    <tr>
                        <td style="width: 70%;">${item.name}</td>
                        <td class="item-total-pr" style="width: 30%; text-align: right;">Rs. ${item.price.toFixed(2)}</td>
                    </tr>
                </table>
            `).join('');
            
            document.getElementById('foodItems').innerHTML = foodItemsHtml;
            
            const foodTotal = booking.foodItems.reduce((sum, item) => sum + item.price, 0);
            document.getElementById('foodTotal').textContent = 'Rs. ' + foodTotal.toFixed(2);
        }

        // Medicine items
        if (booking.medicineItems && booking.medicineItems.length > 0) {
            document.getElementById('medicineSection').style.display = 'block';
            document.getElementById('medicineTotalRow').style.display = 'table-row';
            
            const medicineItemsHtml = booking.medicineItems.map(item => `
                <table style="margin: 2px 0;">
                    <tr>
                        <td style="width: 70%;">${item.name}</td>
                        <td class="item-total-pr" style="width: 30%; text-align: right;">Rs. ${item.price.toFixed(2)}</td>
                    </tr>
                </table>
            `).join('');
            
            document.getElementById('medicineItems').innerHTML = medicineItemsHtml;
            
            const medicineTotal = booking.medicineItems.reduce((sum, item) => sum + item.price, 0);
            document.getElementById('medicineTotal').textContent = 'Rs. ' + medicineTotal.toFixed(2);
        }

        // Extra costs
        if (booking.extraCosts && booking.extraCosts > 0) {
            document.getElementById('extraCostsRow').style.display = 'table-row';
            document.getElementById('extraCosts').textContent = 'Rs. ' + booking.extraCosts.toFixed(2);
        }

        // Notes
        if (booking.notes && booking.notes.trim()) {
            document.getElementById('notesSection').style.display = 'block';
            document.getElementById('notes').textContent = booking.notes;
        }

        // Totals
        document.getElementById('baseChargeTotal').textContent = 'Rs. ' + baseCharge.toFixed(2);
        document.getElementById('grandTotal').textContent = 'Rs. ' + booking.subTotal.toFixed(2);

        // Auto print after load
        window.onload = function() {
            // Adjust page size dynamically
            const lastTxtElement = document.getElementById('lastTxt');
            if (lastTxtElement) {
                const lastTxtRect = lastTxtElement.getBoundingClientRect();
                const dynamicHeight = lastTxtRect.bottom;

                const style = document.createElement('style');
                style.textContent = `
                    @page {
                        margin: 25px;
                        size: 72mm ${dynamicHeight}px;
                        width: 72mm;
                        height: ${dynamicHeight}px;
                    }
                    @media print {
                        body {
                            height: ${dynamicHeight}px;
                        }
                    }
                `;
                document.head.appendChild(style);
            }

            // Trigger print
            setTimeout(() => {
                window.print();
                
                // Auto close after print (except on localhost)
                if (window.location.hostname !== '127.0.0.1' && window.location.hostname !== 'localhost') {
                    setTimeout(() => {
                        window.close();
                    }, 1000);
                }
            }, 500);
        };
    } else {
        document.getElementById('invoice').innerHTML = `
            <div class="center" style="padding: 20px;">
                <div style="font-size: 14px; font-weight: bold; margin-bottom: 10px;">Booking Not Found</div>
                <div style="font-size: 11px;">The booking you're looking for doesn't exist.</div>
            </div>
        `;
    }
</script>

</html>
