<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Application | Supplier Management</title>
    <link rel="icon" href="../../images/favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/flowbite@2.5.2/dist/flowbite.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="../../styles/common.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
</head>

<body class="bg-gray-50 h-screen flex flex-col overflow-hidden">
    <!-- Header -->
    <header class="bg-white border-b h-16 flex items-center px-8 justify-between z-10">
        <div class="flex items-center gap-4">
            <button onclick="window.location.href = '../';" class="p-2 rounded-full hover:bg-gray-100 text-gray-600">
                <i class="bi bi-arrow-left text-xl"></i>
            </button>
            <h1 class="text-xl font-bold text-gray-800">Supplier Management</h1>
        </div>
        <div class="flex items-center gap-4">
            <button onclick="openAddModal()"
                class="bg-basic text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-opacity-90 flex items-center gap-2">
                <i class="bi bi-plus-lg"></i> New Supplier
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex-grow flex overflow-hidden">
        <!-- Sidebar: Supplier List -->
        <div class="w-1/3 bg-white border-r flex flex-col">
            <div class="p-4 border-b">
                <div class="relative">
                    <i class="bi bi-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="searchSupplier" onkeyup="renderSupplierList()"
                        placeholder="Search suppliers..."
                        class="w-full pl-10 pr-4 py-2 border rounded-lg text-sm bg-gray-50 focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>

            <div id="supplierList" class="flex-grow overflow-y-auto">
                <!-- List Items Injected Here -->
            </div>
        </div>

        <!-- Main Panel: Supplier Details & Ledger -->
        <div class="w-2/3 bg-gray-50 flex flex-col relative">

            <!-- Empty State -->
            <div id="emptyState" class="absolute inset-0 flex flex-col items-center justify-center text-gray-400">
                <i class="bi bi-shop text-6xl mb-4"></i>
                <p class="text-lg">Select a supplier to view details</p>
            </div>

            <!-- Details View -->
            <div id="detailsPanel" class="hidden flex-col h-full">
                <!-- Top Info Card -->
                <div class="bg-white p-6 border-b shadow-sm">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800" id="viewName">Supplier Name</h2>
                            <p class="text-sm text-gray-500" id="viewContact">Contact Info</p>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-gray-500 uppercase font-bold tracking-wider">Net Balance</div>
                            <div class="text-3xl font-bold" id="viewBalance">0.00</div>
                            <div class="text-xs mt-1" id="balanceLabel">To Pay</div>
                        </div>
                    </div>

                    <div class="flex gap-3">
                        <button onclick="openTransactionModal('payment')"
                            class="flex-1 bg-green-100 text-green-700 py-2 rounded-lg font-medium hover:bg-green-200 transition-colors">
                            <i class="bi bi-arrow-up-right"></i> Record Payment (Out)
                        </button>
                        <button onclick="openTransactionModal('invoice')"
                            class="flex-1 bg-orange-100 text-orange-700 py-2 rounded-lg font-medium hover:bg-orange-200 transition-colors">
                            <i class="bi bi-arrow-down-left"></i> Received Goods (In)
                        </button>
                        <button onclick="deleteSupplier()"
                            class="px-3 bg-gray-100 text-gray-600 rounded-lg hover:bg-red-100 hover:text-red-600 transition-colors">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>

                <!-- Transaction History -->
                <div class="flex-grow overflow-y-auto p-6">
                    <h3 class="text-sm font-bold text-gray-700 uppercase tracking-wide mb-3">Transaction History</h3>
                    <div class="bg-white rounded-lg shadow border overflow-hidden">
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                                <tr>
                                    <th class="px-6 py-3">Date</th>
                                    <th class="px-6 py-3">Description</th>
                                    <th class="px-6 py-3 text-right">Debit (In)</th>
                                    <th class="px-6 py-3 text-right">Credit (Out)</th>
                                </tr>
                            </thead>
                            <tbody id="transactionTable">
                                <!-- Rows -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Supplier Modal -->
    <div id="addSupplierModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center">
        <div class="bg-white rounded-lg w-full max-w-md p-6">
            <h3 class="text-lg font-bold mb-4">Add New Supplier</h3>
            <form id="addForm" onsubmit="saveSupplier(event)">
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-1">Supplier Name</label>
                    <input type="text" id="inpName" required class="w-full border rounded p-2">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-1">Contact / Phone</label>
                    <input type="text" id="inpContact" class="w-full border rounded p-2">
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" onclick="closeModals()"
                        class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancel</button>
                    <button type="submit"
                        class="px-4 py-2 bg-basic text-white rounded hover:bg-opacity-90">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Transaction Modal -->
    <div id="transactionModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center">
        <div class="bg-white rounded-lg w-full max-w-md p-6">
            <h3 class="text-lg font-bold mb-4" id="transModalTitle">Log Transaction</h3>
            <form id="transForm" onsubmit="saveTransaction(event)">
                <input type="hidden" id="transType">
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-1">Date</label>
                    <input type="date" id="transDate" required class="w-full border rounded p-2">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-1">Amount</label>
                    <input type="number" id="transAmount" step="0.01" required class="w-full border rounded p-2">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-1">Description / Ref ID</label>
                    <input type="text" id="transDesc" required class="w-full border rounded p-2"
                        placeholder="e.g. Invoice #123">
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" onclick="closeModals()"
                        class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancel</button>
                    <button type="submit"
                        class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Record</button>
                </div>
            </form>
        </div>
    </div>

    <script src="../../scripts/common.js"></script>
    <script>
        // --- Data ---
        let suppliers = JSON.parse(localStorage.getItem('suppliers_ledger')) || [
            { id: 1, name: 'Healthguard Pharmacy', contact: '011-2334455', transactions: [] },
            { id: 2, name: 'Wellmart Distributors', contact: '077-1234567', transactions: [] }
        ];

        // Mocking transactions if empty for demo
        if (suppliers[0].transactions.length === 0) {
            suppliers[0].transactions = [
                { id: 1, date: '2026-02-01', type: 'invoice', amount: 50000, desc: 'Stock Replenishment #Inv001' },
                { id: 2, date: '2026-02-05', type: 'payment', amount: 20000, desc: 'Partial Payment' }
            ];
            saveData();
        }

        let selectedSupplierId = null;

        // --- Render ---
        function renderSupplierList() {
            const list = document.getElementById('supplierList');
            const search = document.getElementById('searchSupplier').value.toLowerCase();
            list.innerHTML = '';

            const filtered = suppliers.filter(s => s.name.toLowerCase().includes(search));

            filtered.forEach(s => {
                const balance = calculateBalance(s);
                const isSelected = s.id === selectedSupplierId;

                const item = document.createElement('div');
                item.className = `p-4 border-b cursor-pointer hover:bg-gray-50 transition-colors ${isSelected ? 'bg-blue-50 border-l-4 border-l-blue-500' : ''}`;
                item.onclick = () => selectSupplier(s.id);

                item.innerHTML = `
                    <div class="flex justify-between items-start">
                        <h4 class="font-bold text-gray-800">${s.name}</h4>
                        <span class="text-xs font-bold ${balance > 0 ? 'text-red-500' : 'text-green-500'}">
                            ${balance > 0 ? 'Due' : 'Credit'}
                        </span>
                    </div>
                    <div class="flex justify-between items-end mt-1">
                        <p class="text-xs text-gray-500">${s.contact}</p>
                        <span class="font-medium text-gray-700">${Math.abs(balance).toFixed(2)}</span>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        function selectSupplier(id) {
            selectedSupplierId = id;
            renderSupplierList(); // Refresh highlighting

            const supplier = suppliers.find(s => s.id === id);
            if (!supplier) return;

            // Update Details View
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('detailsPanel').classList.remove('hidden');
            document.getElementById('detailsPanel').classList.add('flex');

            document.getElementById('viewName').textContent = supplier.name;
            document.getElementById('viewContact').textContent = supplier.contact || 'No Contact Info';

            const bal = calculateBalance(supplier);
            const balEl = document.getElementById('viewBalance');
            const lblEl = document.getElementById('balanceLabel');

            balEl.innerText = Math.abs(bal).toLocaleString('en-US', { minimumFractionDigits: 2 });

            if (bal > 0) {
                balEl.className = 'text-3xl font-bold text-red-600';
                lblEl.innerText = 'Total Amount to Pay (Due)';
                lblEl.className = 'text-xs mt-1 text-red-600 font-bold uppercase';
            } else if (bal < 0) {
                balEl.className = 'text-3xl font-bold text-green-600';
                lblEl.innerText = 'Advance / Credit Available';
                lblEl.className = 'text-xs mt-1 text-green-600 font-bold uppercase';
            } else {
                balEl.className = 'text-3xl font-bold text-gray-400';
                lblEl.innerText = 'Settled';
                lblEl.className = 'text-xs mt-1 text-gray-500 font-bold uppercase';
            }

            renderTransactions(supplier);
        }

        function renderTransactions(supplier) {
            const tbody = document.getElementById('transactionTable');
            tbody.innerHTML = '';

            // Sort by date desc
            const sorted = [...supplier.transactions].sort((a, b) => new Date(b.date) - new Date(a.date));

            if (sorted.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-8 text-center text-gray-400">No transactions recorded.</td></tr>';
                return;
            }

            sorted.forEach(t => {
                const tr = document.createElement('tr');
                tr.className = "bg-white border-b hover:bg-gray-50";

                // Invoice (Goods Received) -> Increases Balance (Debit effect in Payable context, but let's stick to simple In/Out)
                // Let's say: 
                // Invoice = Amount we OWE (Debit or Credit column? Usually Credit creates liability). 
                // Let's make it simpler:
                // "Goods In" column (Increases Debt) | "Payment Out" column (Reduces Debt)

                const isInvoice = t.type === 'invoice';

                tr.innerHTML = `
                    <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${t.date}</td>
                    <td class="px-6 py-4">
                        <span class="block text-gray-700">${t.desc}</span>
                        <span class="text-xs ${isInvoice ? 'text-orange-600' : 'text-green-600'} italic capitalize">${t.type}</span>
                    </td>
                    <td class="px-6 py-4 text-right font-medium ${isInvoice ? 'text-gray-900' : 'text-gray-300'}">
                        ${isInvoice ? parseFloat(t.amount).toFixed(2) : '-'}
                    </td>
                    <td class="px-6 py-4 text-right font-medium ${!isInvoice ? 'text-green-600' : 'text-gray-300'}">
                        ${!isInvoice ? parseFloat(t.amount).toFixed(2) : '-'}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- Logic ---
        function calculateBalance(supplier) {
            // Invoice (+) means we owe. Payment (-) means we paid.
            // Balance = Total Invoices - Total Payments
            let bal = 0;
            supplier.transactions.forEach(t => {
                if (t.type === 'invoice') bal += parseFloat(t.amount);
                else if (t.type === 'payment') bal -= parseFloat(t.amount);
            });
            return bal;
        }

        function saveData() {
            localStorage.setItem('suppliers_ledger', JSON.stringify(suppliers));
        }

        function openAddModal() {
            document.getElementById('addSupplierModal').classList.remove('hidden');
        }

        function closeModals() {
            document.getElementById('addSupplierModal').classList.add('hidden');
            document.getElementById('transactionModal').classList.add('hidden');
        }

        function saveSupplier(e) {
            e.preventDefault();
            const name = document.getElementById('inpName').value;
            const contact = document.getElementById('inpContact').value;

            suppliers.push({
                id: Date.now(),
                name,
                contact,
                transactions: []
            });
            saveData();
            closeModals();
            renderSupplierList();
            document.getElementById('addForm').reset();
        }

        function deleteSupplier() {
            if (!selectedSupplierId) return;
            if (confirm("Delete this supplier and all history?")) {
                suppliers = suppliers.filter(s => s.id !== selectedSupplierId);
                saveData();
                selectedSupplierId = null;
                document.getElementById('detailsPanel').classList.add('hidden');
                document.getElementById('detailsPanel').classList.remove('flex');
                document.getElementById('emptyState').classList.remove('hidden');
                renderSupplierList();
            }
        }

        // Transactions
        function openTransactionModal(type) {
            document.getElementById('transType').value = type;
            document.getElementById('transModalTitle').innerText = type === 'invoice' ? 'Record Goods Received (Bill In)' : 'Record Payment (Cash Out)';
            document.getElementById('transDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('transactionModal').classList.remove('hidden');
        }

        function saveTransaction(e) {
            e.preventDefault();
            const supplier = suppliers.find(s => s.id === selectedSupplierId);
            if (!supplier) return;

            const type = document.getElementById('transType').value;
            const date = document.getElementById('transDate').value;
            const amount = parseFloat(document.getElementById('transAmount').value);
            const desc = document.getElementById('transDesc').value;

            supplier.transactions.push({
                id: Date.now(),
                date,
                type,
                amount,
                desc
            });

            saveData();
            closeModals();
            selectSupplier(selectedSupplierId); // Refresh view
            document.getElementById('transForm').reset();
        }

        // Init
        renderSupplierList();

    </script>
</body>

</html>