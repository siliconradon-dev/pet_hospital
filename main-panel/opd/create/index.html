<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Application | New OPD Entry</title>
    <link rel="icon" href="../../../images/favicon.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../../../styles/common.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
</head>

<body class="min-h-screen flex flex-col bg-gray-50">

    <!--Nav-->
    <div class="nav bg-basic w-full py-4 flex justify-between items-center px-8 shadow-md">
        <!-- Left: Navigation -->
        <div class="flex items-center gap-4">
            <button onclick="history.back()"
                class="w-10 h-10 bg-white text-basic rounded-full flex items-center justify-center hover:scale-95 transition-transform shadow-sm">
                <i class="bi bi-chevron-left text-lg"></i>
            </button>
            <button onclick="window.location.href = '../../';"
                class="px-4 py-2 bg-white text-basic rounded-lg flex items-center gap-2 hover:scale-95 transition-transform shadow-sm font-semibold text-sm">
                <i class="bi bi-building"></i>
                <span class="hidden sm:inline">Go to Main Panel</span>
            </button>
        </div>

        <!-- Center: Logo -->
        <div class="flex-1 flex justify-center">
            <img src="../../../images/logo.png" alt="Logo" class="h-12 w-auto drop-shadow-md">
        </div>

        <!-- Right: User Info -->
        <div class="flex items-center gap-4">
            <div class="text-right text-white hidden sm:block">
                <h2 class="text-lg font-bold leading-tight">Good Evening!</h2>
                <p class="text-xs text-blue-200">Welcome Admin</p>
            </div>
            <button onclick="window.location.href = '../../../';"
                class="w-10 h-10 bg-white text-basic rounded-full flex items-center justify-center hover:scale-95 transition-transform shadow-sm">
                <i class="bi bi-box-arrow-right text-lg"></i>
            </button>
        </div>
    </div>
    <!-- Spacer -->

    <!-- Main Content -->
    <div class="flex-grow flex flex-col w-full">
        <!-- Breadcrumbs -->
        <div class="page-padding">
            <nav class="flex" aria-label="Breadcrumb">
                <ol class="inline-flex items-center space-x-1 md:space-x-2 rtl:space-x-reverse">
                    <li class="inline-flex items-center">
                        <a href="../../opd/index.html"
                            class="inline-flex items-center text-sm font-medium text-gray-700 hover:text-blue-600 transition-colors">
                            <svg class="w-3 h-3 me-2.5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"
                                fill="currentColor" viewBox="0 0 20 20">
                                <path
                                    d="m19.707 9.293-2-2-7-7a1 1 0 0 0-1.414 0l-7 7-2 2a1 1 0 0 0 1.414 1.414L2 10.414V18a2 2 0 0 0 2 2h3a1 1 0 0 0 1-1v-4a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v4a1 1 0 0 0 1 1h3a2 2 0 0 0 2-2v-7.586l.293.293a1 1 0 0 0 1.414-1.414Z" />
                            </svg>
                            OPD Management
                        </a>
                    </li>
                    <li aria-current="page">
                        <div class="flex items-center">
                            <svg class="rtl:rotate-180 w-3 h-3 text-gray-400 mx-1" aria-hidden="true"
                                xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10">
                                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                                    stroke-width="2" d="m1 9 4-4-4-4" />
                            </svg>
                            <span class="ms-1 text-sm font-medium text-gray-500 md:ms-2">New OPD Entry</span>
                        </div>
                    </li>
                </ol>
            </nav>
        </div>

        <!-- Form Panel -->
        <div class="page-padding">
            <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-8">

                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-3">
                    <span class="bg-blue-100 text-basic p-2 rounded-lg"><i
                            class="bi bi-file-earmark-medical"></i></span>
                    Visit Details
                </h2>

                <!-- Section 1: Pet Details -->
                <div class="grid gap-6 mb-8 md:grid-cols-2">
                    <div>
                        <label for="pet_id" class="block mb-2 text-sm font-bold text-gray-700">Patient (Pet Name/ID)
                            *</label>
                        <div class="relative">
                            <select id="pet_id"
                                class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 outline-none appearance-none"
                                required>
                                <option value="">-- Select Patient --</option>
                                <!-- Options populated via JS -->
                            </select>
                            <i
                                class="bi bi-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                        </div>
                    </div>
                    <div>
                        <label for="visit_date" class="block mb-2 text-sm font-bold text-gray-700">Visit Date *</label>
                        <input type="date" id="visit_date"
                            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 outline-none"
                            required />
                    </div>
                </div>

                <div class="border-t border-gray-200 my-8"></div>

                <!-- Section 2: Service Details -->
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center gap-3">
                        <span class="bg-indigo-100 text-indigo-700 p-2 rounded-lg"><i
                                class="bi bi-ui-checks"></i></span>
                        Services & Procedures
                    </h2>
                </div>

                <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 mb-8">
                    <div class="grid gap-6 mb-6 md:grid-cols-2">
                        <div>
                            <label for="service_title" class="block mb-2 text-sm font-bold text-gray-700">Service Title
                                *</label>
                            <input type="text" id="service_title"
                                class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 outline-none"
                                placeholder="e.g. Consultation, Vaccination..." />
                        </div>
                        <div>
                            <label for="service_price" class="block mb-2 text-sm font-bold text-gray-700">Price (LKR)
                                *</label>
                            <input type="number" id="service_price" min="0" step="0.01"
                                class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 outline-none"
                                placeholder="0.00" />
                        </div>
                    </div>

                    <div class="grid gap-6 mb-6 md:grid-cols-2">
                        <div>
                            <label for="service_desc" class="block mb-2 text-sm font-bold text-gray-700">Description /
                                Notes</label>
                            <textarea id="service_desc" rows="5"
                                class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 outline-none resize-none"
                                placeholder="Detailed medical notes..."></textarea>
                        </div>
                        <div>
                            <label class="block mb-2 text-sm font-bold text-gray-700 flex justify-between">
                                <span>Touch Panel (Draw Notes)</span>
                                <button type="button" onclick="clearCanvas()"
                                    class="text-xs text-red-500 hover:text-red-700 font-bold uppercase"><i
                                        class="bi bi-eraser"></i> Clear</button>
                            </label>
                            <div
                                class="border border-gray-300 rounded-lg overflow-hidden bg-white shadow-inner h-[134px]">
                                <canvas id="touch_panel_canvas" height="134"
                                    class="w-full cursor-crosshair touch-none"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end">
                        <button type="button" onclick="addService()"
                            class="text-white bg-basic hover:bg-[#1a3b75] font-bold rounded-lg text-sm px-6 py-2.5 shadow-md flex items-center gap-2 transition-all">
                            <i class="bi bi-plus-lg"></i> Add to List
                        </button>
                    </div>
                </div>

                <!-- Added Services List -->
                <div class="mb-8">
                    <h3 class="text-md font-bold text-gray-700 uppercase tracking-wider mb-4 border-b pb-2">Added
                        Services</h3>
                    <div class="relative overflow-x-auto rounded-lg border border-gray-200">
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50 border-b border-gray-200">
                                <tr>
                                    <th scope="col" class="px-6 py-3 font-bold">Service Title</th>
                                    <th scope="col" class="px-6 py-3 font-bold text-right">Price</th>
                                    <th scope="col" class="px-6 py-3 font-bold">Description</th>
                                    <th scope="col" class="px-6 py-3 font-bold text-center">Touch Note</th>
                                    <th scope="col" class="px-6 py-3 font-bold text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody id="services_table_body">
                                <tr class="bg-white border-b hover:bg-gray-50">
                                    <td colspan="5" class="px-6 py-8 text-center text-gray-400 italic">No services added
                                        yet.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="flex justify-end items-center gap-4 mt-8 border-t border-gray-100 pt-6">
                    <button type="button" onclick="resetForm()"
                        class="px-6 py-3 text-gray-600 hover:bg-gray-100 rounded-lg font-bold transition-colors">Reset
                        Form</button>
                    <button type="button" onclick="saveOPD()"
                        class="px-8 py-3 bg-green-600 text-white rounded-lg font-bold shadow-lg hover:bg-green-700 hover:shadow-xl transition-all flex items-center gap-2">
                        <i class="bi bi-save"></i> Save Entry & View Bill
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->


    <!-- Bill Summary Modal -->
    <div id="billSummaryModal"
        class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center backdrop-blur-sm">
        <div
            class="bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col overflow-hidden transform transition-all scale-100">
            <!-- Header -->
            <div class="bg-basic p-6 flex justify-between items-center text-white">
                <div>
                    <h2 class="text-2xl font-bold">Bill Summary</h2>
                    <p class="text-blue-200 text-sm mt-0.5">Review transaction details</p>
                </div>
                <button onclick="closeBillModal()"
                    class="text-white hover:bg-white/20 rounded-full p-2 transition-colors">
                    <i class="bi bi-x-lg text-lg"></i>
                </button>
            </div>

            <!-- Body -->
            <div class="p-8 bg-gray-50/50">
                <div class="flex justify-between items-end mb-6 border-b border-gray-200 pb-4">
                    <div>
                        <p class="text-gray-500 text-xs font-bold uppercase tracking-wide">Total Amount</p>
                        <h3 class="text-3xl font-extrabold text-gray-800 mt-1" id="modalTotalAmount">0.00</h3>
                    </div>
                    <div class="text-right">
                        <span
                            class="bg-yellow-100 text-yellow-800 text-xs font-bold px-3 py-1 rounded-full border border-yellow-200 uppercase tracking-wide">Pending</span>
                    </div>
                </div>

                <div class="space-y-4 mb-8 bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                    <div class="flex justify-between border-b border-gray-100 pb-2">
                        <span class="text-gray-500 text-sm font-medium">Reference</span>
                        <span class="font-bold text-gray-900 font-mono" id="modalRef">OPD-XXX</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500 text-sm font-medium">Patient</span>
                        <span class="font-bold text-gray-900" id="modalPetName">Max</span>
                    </div>
                </div>

                <!-- Scrollable Service List -->
                <div class="mb-8">
                    <h4 class="text-xs font-bold text-gray-500 uppercase mb-3 px-1">Service Details</h4>
                    <div id="modalServiceItems" class="space-y-2 max-h-40 pr-2">
                        <!-- Items injected here -->
                    </div>
                </div>

                <div class="bg-blue-50 rounded-xl p-5 mb-8 border border-blue-100">
                    <div class="flex justify-between items-center mb-3">
                        <label class="text-sm font-bold text-blue-900">Advance Payment</label>
                        <input type="number" id="modalAdvance" placeholder="0.00" oninput="calculateBalance()"
                            class="w-32 text-right border border-blue-200 rounded-lg px-3 py-1.5 text-sm font-mono font-bold focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div class="flex justify-between items-center border-t border-blue-200 pt-3">
                        <span class="text-sm font-bold text-blue-800">Balance Due</span>
                        <span class="text-xl font-extrabold text-red-600 font-mono" id="modalBalance">0.00</span>
                    </div>
                </div>

                <button onclick="proceedToBilling()"
                    class="w-full py-4 bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl shadow-lg hover:shadow-xl transition-all flex justify-center items-center gap-2 group transform active:scale-95">
                    <span>SEND TO BILLING</span>
                    <i class="bi bi-arrow-right group-hover:translate-x-1 transition-transform"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // --- Canvas Drawing Logic ---
        const canvas = document.getElementById('touch_panel_canvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;

        function resizeCanvas() {
            if (canvas.width !== canvas.parentElement.clientWidth) {
                canvas.width = canvas.parentElement.clientWidth;
            }
            ctx.lineWidth = 2;
            ctx.lineJoin = 'round';
            ctx.lineCap = 'round';
            ctx.strokeStyle = '#000000';
        }

        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return {
                x: clientX - rect.left,
                y: clientY - rect.top
            };
        }

        function startDrawing(e) {
            isDrawing = true;
            const pos = getPos(e);
            lastX = pos.x;
            lastY = pos.y;
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(lastX, lastY);
            ctx.stroke();
        }

        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault();
            const pos = getPos(e);
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
            lastX = pos.x;
            lastY = pos.y;
        }

        function stopDrawing() {
            isDrawing = false;
        }

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);

        canvas.addEventListener('touchstart', startDrawing, { passive: false });
        canvas.addEventListener('touchmove', draw, { passive: false });
        canvas.addEventListener('touchend', stopDrawing);
    </script>
    <script>
        document.getElementById('visit_date').valueAsDate = new Date();

        if (!localStorage.getItem('pets')) {
            const testPets = [
                { code: 'P001', name: 'Buddy', owner: 'John Doe', type: 'Dog' },
                { code: 'P002', name: 'Luna', owner: 'Jane Smith', type: 'Cat' },
                { code: 'P003', name: 'Max', owner: 'Mike Ross', type: 'Dog' },
                { code: 'P004', name: 'Bella', owner: 'Rachel Green', type: 'Bird' },
                { code: 'P005', name: 'Charlie', owner: 'Emily Blunt', type: 'Cat' }
            ];
            localStorage.setItem('pets', JSON.stringify(testPets));
        }

        const pets = JSON.parse(localStorage.getItem('pets')) || [];
        const petSelect = document.getElementById('pet_id');
        pets.forEach(pet => {
            const option = document.createElement('option');
            option.value = pet.code;
            option.textContent = `${pet.name} (${pet.code})`;
            petSelect.appendChild(option);
        });

        let services = [];

        function addService() {
            const title = document.getElementById('service_title').value.trim();
            const price = document.getElementById('service_price').value.trim();
            const desc = document.getElementById('service_desc').value.trim();
            const canvas = document.getElementById('touch_panel_canvas');
            const isCanvasBlank = !canvas.getContext('2d').getImageData(0, 0, canvas.width, canvas.height).data.some(channel => channel !== 0);
            const tpImage = isCanvasBlank ? null : canvas.toDataURL();

            if (!title) return alert("Service Title is required!");
            if (!price) return alert("Price is required!");

            const service = {
                id: Date.now(),
                title: title,
                price: parseFloat(price).toFixed(2),
                description: desc || '-',
                touchPanelImage: tpImage
            };

            services.unshift(service);
            renderServices();
            clearServiceForm();
        }

        function removeService(id) {
            services = services.filter(s => s.id !== id);
            renderServices();
        }

        function renderServices() {
            const tbody = document.getElementById('services_table_body');
            tbody.innerHTML = '';

            if (services.length === 0) {
                tbody.innerHTML = '<tr class="bg-white border-b hover:bg-gray-50"><td colspan="5" class="px-6 py-8 text-center text-gray-400 italic">No services added yet.</td></tr>';
                return;
            }

            let total = 0;
            services.forEach(service => {
                total += parseFloat(service.price);
                const row = document.createElement('tr');
                row.className = 'bg-white border-b hover:bg-gray-50 transition-colors';
                row.innerHTML = `
                <td class="px-6 py-4 font-bold text-gray-900">${service.title}</td>
                <td class="px-6 py-4 font-medium text-right font-mono text-gray-700">${service.price}</td>
                <td class="px-6 py-4 block max-w-xs truncate text-xs text-gray-500" title="${service.description}">${service.description}</td>
                <td class="px-6 py-4 text-center">
                    ${service.touchPanelImage
                        ? `<img src="${service.touchPanelImage}" class="h-10 w-auto border rounded bg-white mx-auto shadow-sm p-0.5" alt="Note">`
                        : '<span class="text-gray-300 text-[10px] italic">Empty</span>'}
                </td>
                <td class="px-6 py-4 text-center">
                    <button onclick="removeService(${service.id})" class="text-red-400 hover:text-red-600 hover:bg-red-50 p-2 rounded-full transition-all">
                        <i class="bi bi-trash3-fill"></i>
                    </button>
                </td>
            `;
                tbody.appendChild(row);
            });

            const totalRow = document.createElement('tr');
            totalRow.className = 'bg-gray-50 font-bold text-gray-900 border-t-2 border-gray-200';
            totalRow.innerHTML = `
            <td class="px-6 py-4 text-right uppercase text-xs tracking-wider">Total Amount</td>
            <td class="px-6 py-4 text-right text-lg text-basic font-extrabold">${total.toFixed(2)}</td>
            <td colspan="3"></td>
        `;
            tbody.appendChild(totalRow);
        }

        function clearServiceForm() {
            document.getElementById('service_title').value = '';
            document.getElementById('service_price').value = '';
            document.getElementById('service_desc').value = '';
            clearCanvas();
            document.getElementById('service_title').focus();
        }

        function saveOPD() {
            const petId = document.getElementById('pet_id').value;
            const visitDate = document.getElementById('visit_date').value;

            if (!petId || !visitDate) return alert('Please select a pet and visit date');
            if (services.length === 0 && !confirm("No services added. Continue?")) return;

            const opdEntries = JSON.parse(localStorage.getItem('opd_entries')) || [];
            const entryCode = 'OPD' + String(opdEntries.length + 1).padStart(5, '0');
            const totalAmount = services.reduce((sum, s) => sum + parseFloat(s.price), 0);

            const entry = {
                code: entryCode,
                petId: petId,
                visitDate: visitDate,
                services: services,
                totalAmount: totalAmount.toFixed(2),
                createdAt: new Date().toISOString()
            };

            opdEntries.push(entry);
            localStorage.setItem('opd_entries', JSON.stringify(opdEntries));
            showBillModal(entry, totalAmount);
        }

        let currentEntry = null;

        function showBillModal(entry, total) {
            currentEntry = entry;
            document.getElementById('modalTotalAmount').innerText = total.toFixed(2);
            document.getElementById('modalRef').innerText = entry.code;
            document.getElementById('modalAdvance').value = '';
            document.getElementById('modalBalance').innerText = total.toFixed(2);

            const petSelect = document.getElementById('pet_id');
            const petName = petSelect.options[petSelect.selectedIndex].text;
            document.getElementById('modalPetName').innerText = petName;

            const list = document.getElementById('modalServiceItems');
            list.innerHTML = '';

            entry.services.forEach(s => {
                const row = document.createElement('div');
                row.className = "flex justify-between text-sm py-2 border-b border-gray-100 last:border-0";
                row.innerHTML = `
                    <span class="text-gray-700 truncate w-2/3 font-medium">${s.title}</span>
                    <span class="font-mono text-gray-900">${s.price}</span>
                `;
                list.appendChild(row);
            });

            document.getElementById('billSummaryModal').classList.remove('hidden');
        }

        function closeBillModal() {
            document.getElementById('billSummaryModal').classList.add('hidden');
            window.location.href = '../list/index.html';
        }

        function calculateBalance() {
            const total = parseFloat(currentEntry.totalAmount) || 0;
            const advance = parseFloat(document.getElementById('modalAdvance').value) || 0;
            const balance = total - advance;
            document.getElementById('modalBalance').innerText = balance.toFixed(2);
        }

        function proceedToBilling() {
            const advance = parseFloat(document.getElementById('modalAdvance').value) || 0;
            if (advance > 0 && currentEntry) {
                const opdEntries = JSON.parse(localStorage.getItem('opd_entries')) || [];
                const idx = opdEntries.findIndex(e => e.code === currentEntry.code);
                if (idx !== -1) {
                    opdEntries[idx].advanceAmount = advance.toFixed(2);
                    localStorage.setItem('opd_entries', JSON.stringify(opdEntries));
                }
            }
            window.location.href = '../../final-billing/index.html';
        }

        function resetForm() {
            document.getElementById('pet_id').value = '';
            document.getElementById('visit_date').valueAsDate = new Date();
            services = [];
            renderServices();
            clearServiceForm();
        }
    </script>
    <footer class="mt-auto bg-basic py-4 text-center text-white text-xs w-full">
        <p>2026 Â© All Rights Reserved | Royal Pets Animal Hospital | Designed and Developed by Silicon Radon Networks
            (Pvt) Ltd</p>
    </footer>
</body>

</html>